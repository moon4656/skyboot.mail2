# SkyBoot Mail SaaS - Auth Router 테스트 계획서

## 📋 개요
- **대상 파일**: `c:\Users\eldorado\skyboot.mail2\backend\app\router\auth_router.py`
- **테스트 범위**: 인증 관련 모든 엔드포인트 및 보안 기능
- **테스트 환경**: SaaS 다중 조직 지원 환경
- **Admin 계정**: admin@skyboot.com / Admin123!@#

## 🎯 테스트 목표
1. **기능 검증**: 모든 인증 엔드포인트의 정상 동작 확인
2. **보안 검증**: JWT 토큰, 비밀번호 해싱, 권한 관리 검증
3. **다중 조직 지원**: 조직별 데이터 격리 및 테넌트 미들웨어 검증
4. **에러 처리**: 예외 상황 및 에러 응답 검증
5. **성능 검증**: 응답 시간 및 동시 요청 처리 능력 확인

## 📊 Auth Router 엔드포인트 분석

### 1. 회원가입 엔드포인트 (`POST /register`)
**기능**: 조직 내에서 새 사용자 생성
- **입력**: UserCreate 스키마 (email, username, password)
- **출력**: UserResponse 스키마
- **특징**: 
  - 조직별 이메일/사용자명 중복 확인
  - 메일 사용자 자동 생성 (MailUser 테이블)
  - UUID 기반 사용자 ID 생성

### 2. 로그인 엔드포인트 (`POST /login`)
**기능**: 사용자 인증 및 JWT 토큰 발급
- **입력**: UserLogin 스키마 (email, password)
- **출력**: Token 스키마 (access_token, refresh_token)
- **특징**:
  - 로그인 로그 기록 (성공/실패)
  - 클라이언트 IP 및 User-Agent 추적
  - 리프레시 토큰 데이터베이스 저장

### 3. 토큰 재발급 엔드포인트 (`POST /refresh`)
**기능**: 리프레시 토큰으로 새 액세스 토큰 발급
- **입력**: TokenRefresh 스키마 (refresh_token)
- **출력**: AccessToken 스키마
- **특징**:
  - 리프레시 토큰 유효성 검증
  - 데이터베이스 토큰 상태 확인
  - 조직별 사용자 검증

### 4. 사용자 정보 조회 엔드포인트 (`GET /me`)
**기능**: 현재 로그인한 사용자 정보 반환
- **입력**: Authorization 헤더 (Bearer 토큰)
- **출력**: UserResponse 스키마
- **특징**:
  - JWT 토큰 검증
  - 사용자 정보 디버깅 로그

## 🧪 테스트 체크포인트

### Phase 1: 기본 기능 테스트
- [ ] **CP-1.1**: 회원가입 정상 케이스
- [ ] **CP-1.2**: 로그인 정상 케이스 (admin@skyboot.com)
- [ ] **CP-1.3**: 토큰 재발급 정상 케이스
- [ ] **CP-1.4**: 사용자 정보 조회 정상 케이스

### Phase 2: 에러 처리 테스트
- [ ] **CP-2.1**: 중복 이메일 회원가입 시도
- [ ] **CP-2.2**: 잘못된 비밀번호 로그인 시도
- [ ] **CP-2.3**: 존재하지 않는 이메일 로그인 시도
- [ ] **CP-2.4**: 만료된 토큰으로 재발급 시도
- [ ] **CP-2.5**: 잘못된 토큰으로 사용자 정보 조회

### Phase 3: 보안 검증 테스트
- [ ] **CP-3.1**: JWT 토큰 구조 및 서명 검증
- [ ] **CP-3.2**: 비밀번호 해싱 검증 (bcrypt)
- [ ] **CP-3.3**: 토큰 만료 시간 검증
- [ ] **CP-3.4**: 리프레시 토큰 무효화 검증
- [ ] **CP-3.5**: 권한 기반 접근 제어 검증

### Phase 4: 다중 조직 지원 테스트
- [ ] **CP-4.1**: 조직별 사용자 데이터 격리 확인
- [ ] **CP-4.2**: 테넌트 미들웨어 동작 확인
- [ ] **CP-4.3**: 조직 간 데이터 접근 차단 확인
- [ ] **CP-4.4**: 기본 조직 할당 로직 확인

### Phase 5: 성능 및 안정성 테스트
- [ ] **CP-5.1**: 동시 로그인 요청 처리 (10개)
- [ ] **CP-5.2**: 응답 시간 측정 (< 1초)
- [ ] **CP-5.3**: 메모리 사용량 모니터링
- [ ] **CP-5.4**: 데이터베이스 연결 풀 상태 확인

### Phase 6: 통합 테스트
- [ ] **CP-6.1**: Postfix 메일 사용자 연동 확인
- [ ] **CP-6.2**: 로그인 로그 데이터베이스 기록 확인
- [ ] **CP-6.3**: 세션 관리 및 토큰 저장소 확인
- [ ] **CP-6.4**: 미들웨어 체인 동작 확인

## 🔧 테스트 환경 설정

### 필수 의존성
```bash
# 테스트 실행 전 확인사항
cd c:\Users\eldorado\skyboot.mail2\backend
pip install -r requirements.txt
```

### 데이터베이스 상태 확인
```sql
-- 테스트 전 확인할 테이블들
SELECT COUNT(*) FROM users;
SELECT COUNT(*) FROM organizations;
SELECT COUNT(*) FROM refresh_tokens;
SELECT COUNT(*) FROM login_logs;
```

### 환경 변수 확인
- `SECRET_KEY`: JWT 서명용 비밀키
- `ACCESS_TOKEN_EXPIRE_MINUTES`: 액세스 토큰 만료 시간
- `REFRESH_TOKEN_EXPIRE_DAYS`: 리프레시 토큰 만료 일수

## 📝 테스트 실행 순서

1. **환경 준비**: 데이터베이스 연결 및 테스트 데이터 확인
2. **기본 기능**: Phase 1 체크포인트 순차 실행
3. **에러 처리**: Phase 2 체크포인트 실행
4. **보안 검증**: Phase 3 체크포인트 실행
5. **다중 조직**: Phase 4 체크포인트 실행
6. **성능 테스트**: Phase 5 체크포인트 실행
7. **통합 테스트**: Phase 6 체크포인트 실행
8. **결과 정리**: 모든 결과를 체크리스트에 기록

## 🚨 주의사항

1. **실제 데이터베이스 사용**: 테스트 시 실제 데이터에 영향을 줄 수 있음
2. **Admin 계정 보호**: admin@skyboot.com 계정 정보 보안 유지
3. **토큰 관리**: 테스트 중 생성된 토큰들의 적절한 정리
4. **로그 모니터링**: 테스트 중 발생하는 로그 메시지 확인
5. **Postfix 연동**: WSL 환경의 Postfix 서버 상태 확인

## 📊 성공 기준

- **기능 테스트**: 모든 정상 케이스 100% 성공
- **에러 처리**: 모든 예외 상황 적절한 에러 응답
- **보안 검증**: JWT 토큰 및 인증 메커니즘 완전성
- **성능 기준**: 평균 응답 시간 < 1초
- **통합 테스트**: Postfix 연동 및 데이터 일관성 확인

---

**작성일**: 2025년 1월 27일  
**작성자**: Trae AI Assistant  
**버전**: 1.0